<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Screen Capture Viewer</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 1200px;
				margin: 0 auto;
				padding: 20px;
				background-color: #f5f5f5;
			}
			h1 {
				color: #333;
				text-align: center;
			}
			.image-container {
				display: flex;
				flex-wrap: wrap;
				gap: 20px;
				justify-content: center;
			}
			.image-card {
				background-color: white;
				border-radius: 8px;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
				overflow: hidden;
				width: 300px;
			}
			.image-card img {
				width: 100%;
				height: auto;
				display: block;
			}
			.image-info {
				padding: 10px;
				font-size: 14px;
				color: #666;
			}
			.timestamp {
				font-size: 12px;
				color: #999;
			}
			.camera-controls {
				margin: 20px 0;
				text-align: center;
			}
			.camera-button {
				padding: 10px 20px;
				margin: 0 10px;
				font-size: 16px;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				transition: background-color 0.3s;
			}
			.front-camera {
				background-color: #4caf50;
				color: white;
			}
			.back-camera {
				background-color: #2196f3;
				color: white;
			}
			.capture-button {
				background-color: #f44336;
				color: white;
				margin-top: 10px;
				width: 200px;
			}
			.camera-button:hover {
				opacity: 0.9;
			}
			.camera-button.active {
				box-shadow: 0 0 0 2px #000;
			}
			.capture-button.active {
				background-color: #d32f2f;
			}
			.status-message {
				text-align: center;
				margin: 10px 0;
				padding: 10px;
				border-radius: 4px;
			}
			.status-message.error {
				background-color: #ffebee;
				color: #c62828;
			}
			.status-message.success {
				background-color: #e8f5e9;
				color: #2e7d32;
			}
		</style>
	</head>
	<body>
		<h1>Screen Capture Viewer</h1>
		<div id="statusMessage" class="status-message"></div>
		<div class="camera-controls">
			<button
				class="camera-button front-camera"
				onclick="selectCamera('front', this)"
			>
				Front Camera
			</button>
			<button
				class="camera-button back-camera"
				onclick="selectCamera('back', this)"
			>
				Back Camera
			</button>
			<div style="margin-top: 15px">
				<button
					id="captureButton"
					class="camera-button capture-button"
					onclick="toggleCapture()"
				>
					Start Capture
				</button>
			</div>
		</div>
		<div class="image-container" id="imageContainer">
			<!-- Images will be added here dynamically -->
		</div>
		<div class="controls">
			<h2>Screen Sharing</h2>
			<div id="roomIdDisplay">Room ID: <span id="roomId"></span></div>
			<button onclick="startScreenShare()">Start Screen Share</button>
			<button onclick="stopScreenShare()">Stop Screen Share</button>
			<button id="screenCaptureBtn" onclick="startScreenCapture()">
				Screen Capture
			</button>
		</div>

		<script src="/socket.io/socket.io.js"></script>
		<script>
			const socket = io();
			let isCapturing = false;
			let currentCamera = "back";
			let roomId = null;
			let androidInterface = null;
			let interfaceCheckInterval = null;
			let isWebView = false;
			let isController = true; // Always enable controller mode by default

			// Check if running in WebView
			function checkIsWebView() {
				return window.Android !== undefined;
			}

			// Check for Android interface
			function checkAndroidInterface() {
				try {
					console.log("Checking Android interface...");
					isWebView = checkIsWebView();

					if (window.Android) {
						console.log(
							"window.Android methods:",
							Object.getOwnPropertyNames(window.Android)
						);

						// Test if interface is working
						const isAvailable = window.Android.isInterfaceAvailable();
						console.log("Interface availability check result:", isAvailable);

						if (isAvailable) {
							androidInterface = window.Android;
							showStatus("Android interface connected");
							clearInterval(interfaceCheckInterval);
							setupCameraControls(true);
							isController = true;
							return true;
						}
					} else {
						console.log("Running in web browser - Controller mode enabled");
						// Always enable controller mode in web browser
						isController = true;
						showStatus("Web browser mode - Controller enabled");
						setupCameraControls(true);
						return true;
					}
				} catch (error) {
					console.error("Error checking Android interface:", error);
					showStatus(
						"Error checking Android interface: " + error.message,
						true
					);
					return false;
				}
				return false;
			}

			function setupCameraControls(enabled) {
				const buttons = document.querySelectorAll(".camera-button");
				buttons.forEach((button) => {
					if (enabled) {
						button.style.opacity = "1";
						button.disabled = false;
					} else {
						button.style.opacity = "0.5";
						button.disabled = true;
					}
				});
			}

			// Camera control functions
			function selectCamera(type, button) {
				// Remove active class from all camera buttons
				document.querySelectorAll(".camera-button").forEach((btn) => {
					if (btn !== button) btn.classList.remove("active");
				});

				// Add active class to clicked button
				button.classList.add("active");
				currentCamera = type;

				try {
					if (androidInterface) {
						// Direct control if in WebView
						androidInterface.selectCamera(type);
						showStatus(`Switched to ${type} camera`);
					} else if (isController) {
						// Send command via socket if in web browser
						socket.emit("cameraCommand", {
							command: "selectCamera",
							cameraType: type,
							roomId: roomId,
						});
						showStatus(`Command sent: Switch to ${type} camera`);
					}
				} catch (error) {
					showStatus(`Failed to switch camera: ${error.message}`, true);
				}
			}

			function toggleCapture() {
				isCapturing = !isCapturing;
				const captureButton = document.getElementById("captureButton");

				try {
					if (androidInterface) {
						// Direct control if in WebView
						if (isCapturing) {
							androidInterface.startCapture();
							captureButton.textContent = "Stop Capture";
							captureButton.classList.add("active");
							showStatus("Started capturing");
						} else {
							androidInterface.stopCapture();
							captureButton.textContent = "Start Capture";
							captureButton.classList.remove("active");
							showStatus("Stopped capturing");
						}
					} else if (isController) {
						// Send command via socket if in web browser
						if (isCapturing) {
							socket.emit("cameraCommand", {
								command: "startCapture",
								roomId: roomId,
							});
							captureButton.textContent = "Stop Capture";
							captureButton.classList.add("active");
							showStatus("Command sent: Start capture");
						} else {
							socket.emit("cameraCommand", {
								command: "stopCapture",
								roomId: roomId,
							});
							captureButton.textContent = "Start Capture";
							captureButton.classList.remove("active");
							showStatus("Command sent: Stop capture");
						}
					}
				} catch (error) {
					showStatus(`Failed to toggle capture: ${error.message}`, true);
				}
			}

			// Initialize when page loads
			window.onload = function () {
				console.log("Page loaded, checking Android interface...");
				// Check immediately
				checkAndroidInterface();

				// Keep checking every second for 10 seconds
				let attempts = 0;
				interfaceCheckInterval = setInterval(() => {
					attempts++;
					console.log(`Attempt ${attempts} to find Android interface...`);
					if (attempts >= 10 || checkAndroidInterface()) {
						clearInterval(interfaceCheckInterval);
					}
				}, 1000);

				// Set back camera as default
				const backButton = document.querySelector(".back-camera");
				if (backButton) {
					backButton.classList.add("active");
				}
			};

			// Show status message
			function showStatus(message, isError = false) {
				console.log(`Status: ${message} (${isError ? "error" : "success"})`);
				const statusDiv = document.getElementById("statusMessage");
				statusDiv.textContent = message;
				statusDiv.className =
					"status-message " + (isError ? "error" : "success");
			}

			// Initialize connection
			socket.on("connect", () => {
				console.log("Socket connected to server");
				showStatus("Connected to server");

				// Generate a unique room ID if not already set
				if (!roomId) {
					roomId = "room_" + Math.random().toString(36).substr(2, 9);
					console.log("Generated room ID:", roomId);
				}

				// Join the room
				socket.emit("join", { roomId: roomId });
				console.log("Joined room:", roomId);
			});

			// Listen for camera commands
			socket.on("cameraCommand", (data) => {
				console.log("Received camera command:", data);

				if (androidInterface) {
					try {
						switch (data.command) {
							case "selectCamera":
								androidInterface.selectCamera(data.cameraType);
								showStatus(`Camera switched to ${data.cameraType}`);
								break;
							case "startCapture":
								androidInterface.startCapture();
								isCapturing = true;
								const startButton = document.getElementById("captureButton");
								startButton.textContent = "Stop Capture";
								startButton.classList.add("active");
								showStatus("Capture started");
								break;
							case "stopCapture":
								androidInterface.stopCapture();
								isCapturing = false;
								const stopButton = document.getElementById("captureButton");
								stopButton.textContent = "Start Capture";
								stopButton.classList.remove("active");
								showStatus("Capture stopped");
								break;
						}
					} catch (error) {
						console.error("Error executing camera command:", error);
						showStatus(`Error executing command: ${error.message}`, true);
					}
				}
			});

			socket.on("connect_error", (error) => {
				console.error("Socket connection error:", error);
				showStatus("Connection error: " + error.message, true);
			});

			// Listen for new images
			socket.on("new-image", function (data) {
				addImage(data.url);
			});

			// Function to add an image to the container
			function addImage(url) {
				const container = document.getElementById("imageContainer");
				const card = document.createElement("div");
				card.className = "image-card";
				const img = document.createElement("img");
				img.src = url;
				img.alt = "Screen capture";
				const info = document.createElement("div");
				info.className = "image-info";
				const timestamp = document.createElement("div");
				timestamp.className = "timestamp";
				timestamp.textContent = new Date().toLocaleString();
				info.appendChild(timestamp);
				card.appendChild(img);
				card.appendChild(info);
				container.insertBefore(card, container.firstChild);
			}
		</script>
	</body>
</html>
